services:
    mongodb:
        image: mongo:latest
        container_name: ${APP_NAME}-database
        restart: unless-stopped
        volumes:
            -   mongodb_data:/data/db
        environment:
            -   MONGO_INITDB_ROOT_USERNAME=${DB_USERNAME}
            -   MONGO_INITDB_ROOT_PASSWORD=${DB_PASSWORD}
            -   MONGO_INITDB_DATABASE=${DB_NAME}
            -   APP_NAME=${APP_NAME}
        networks:
            -   backend-network
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
            interval: 10s
            timeout: 10s
            retries: 2
            start_period: 15s

volumes:
    neo4j_data:
    neo4j_logs:
    mongodb_data:

networks:
    backend-network:
        driver: bridge

    zookeeper:
        image: zookeeper:latest
        container_name: ${APP_NAME}-zookeeper
        restart: unless-stopped
        environment:
            -   ZOOKEEPER_CLIENT_PORT=${ZOOKEEPER_CLIENT_PORT}
            -   ZOOKEEPER_TICK_TIME=${ZOOKEEPER_TICK_TIME}
            -   APP_NAME=${APP_NAME}
        networks:
            -   backend-network
        healthcheck:
            test: echo stat | nc localhost ${ZOOKEEPER_CLIENT_PORT}
            interval: 10s
            timeout: 10s
            retries: 2
            start_period: 10s

    kafka:
        image: bitnami/kafka:latest
        container_name: ${APP_NAME}-kafka
        restart: unless-stopped
        depends_on:
            zookeeper:
                condition: service_healthy
        ports:
            -   "${KAFKA_PORT}:${KAFKA_PORT}"
        environment:
            -   KAFKA_BROKER_ID=1
            -   KAFKA_ZOOKEEPER_CONNECT=${APP_NAME}-zookeeper:${ZOOKEEPER_CLIENT_PORT}
            -   KAFKA_LISTENERS=PLAINTEXT://localhost:${KAFKA_PORT}
            -   KAFKA_OFFSET_TOPIC_REPLICATION_FACTOR=2
            -   KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
            -   APP_NAME=${APP_NAME}
        networks:
            -   backend-network
        healthcheck:
            test: kafka-broker-api-versions --bootstrap-server localhost:${KAFKA_PORT}
            interval: 10s
            timeout: 10s
            retries: 2
            start_period: 15s